---
title: "00-data-exploration"
author: "Juliane Kloidt"
date: "2025-12-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)

data <- readxl::read_xlsx("data/data-level-3.xlsx")
lookup <- readxl::read_xlsx("data/lookups.xlsx")
```

# Integrate data
```{r}
# filter lookup table to only include Scottish areas
lookup_s <- lookup %>% select(-"...5") %>%
  filter(nation == "Scotland")

# filter data to only include Scottish areas
data_s <- inner_join(data, lookup_s, by=("small_area"))

# save Scottish dataframe as csv
write_csv(data_s, "data/data-scotland.csv")
```

# Explore data
```{r}
unique_areas <- data_s %>% group_by(small_area) %>% tally() %>% nrow() # 6976
unique_authorities <- data_s %>% group_by(local_authority) %>% tally() # 32

# summary statistics across local authorities
authority_data <- data_s %>% group_by(local_authority, `co-benefit_type`) %>%
  # should this be the mean or the sum?
  summarise(mean = mean(sum)) %>% ungroup()

# get top 5 co-benefits for each local authority
authority_data_top5 <- authority_data %>% 
  group_by(`co-benefit_type`) %>% 
  arrange(local_authority, desc(mean)) %>%
  ungroup() %>%
  group_by(local_authority) %>%
  slice(1:5) %>%
  ungroup()

# let's see the absolute numbers for the co-benefits
authority_data_top5_ranked <- authority_data_top5 %>% 
  group_by(`co-benefit_type`) %>%
  summarise(sum = sum(mean)) %>% arrange(desc(sum))



# get bottom 5 co-benefits for each local authority
authority_data_bottom5 <- authority_data %>% 
  group_by(`co-benefit_type`) %>% 
  arrange(local_authority, mean) %>%
  ungroup() %>%
  group_by(local_authority) %>%
  slice(1:5) %>%
  ungroup() # only four out of five factors are negative, thus, show costs

# let's see the absolute numbers for the co-costs
authority_data_bottom5_ranked <- authority_data_bottom5 %>% 
  group_by(`co-benefit_type`) %>%
  summarise(sum = sum(mean)) %>% arrange(sum)
```

Calculate the net benefit for each local authority and divide it by the population (or no. of households) to estimate how much money will be available per person.

```{r}
# summary statistics across local authorities
authority_data <- data_s %>% group_by(local_authority, `co-benefit_type`) %>%
  # weighted sum across small areas within a local authority
  summarise(total_sum = sum(sum)) %>% ungroup() %>%
  pivot_wider(id_cols =c(local_authority), names_from = `co-benefit_type`,
              values_from = "total_sum")

ggplot(authority_data, aes(x=`co-benefit_type`, y=total_sum, fill=`co-benefit_type`)) +
  theme_minimal()+
  geom_col()+
  facet_wrap(~local_authority, ncol=4)

# Co-benefits / Costs per person
look_up_sum <- lookup_s %>% group_by(local_authority) %>% summarise(population=sum(population))

authority_data_weighted <- inner_join(authority_data, look_up_sum, by=c("local_authority")) %>%
  mutate(air_quality_w = air_quality/population,
         congestion_w = congestion/population,
         dampness_w = dampness/population,
         diet_change_w = diet_change/population,
         excess_cold_w = excess_cold/population,
         excess_heat_w = excess_heat/population,
         hassle_costs_w = hassle_costs/population,
         noise_w = noise/population,
         physical_activity_w = physical_activity/population,
         road_repairs_w = road_repairs/population,
         road_safety_w = road_safety/population)

authority_data_weighted %>% select(local_authority, air_quality_w:road_safety_w) %>%
  pivot_longer(cols=c(-local_authority), names_to = "co_benefit", values_to = "sum_pop") %>%
  ggplot(., aes(x= co_benefit, y=sum_pop, fill=co_benefit)) +
  theme_minimal()+
  geom_col()+
  facet_wrap(~local_authority, ncol=4)

# Co-benefits / Costs per household
look_up_sum <- lookup_s %>% group_by(local_authority) %>% summarise(household=sum(households))

authority_data_weighted <- inner_join(authority_data, look_up_sum, by=c("local_authority")) %>%
  mutate(air_quality_w = air_quality/household,
         congestion_w = congestion/household,
         dampness_w = dampness/household,
         diet_change_w = diet_change/household,
         excess_cold_w = excess_cold/household,
         excess_heat_w = excess_heat/household,
         hassle_costs_w = hassle_costs/household,
         noise_w = noise/household,
         physical_activity_w = physical_activity/household,
         road_repairs_w = road_repairs/household,
         road_safety_w = road_safety/household)

authority_data_weighted %>% select(local_authority, air_quality_w:road_safety_w) %>%
  pivot_longer(cols=c(-local_authority), names_to = "co_benefit", values_to = "sum_pop") %>%
  ggplot(., aes(x= co_benefit, y=sum_pop, fill=co_benefit)) +
  theme_minimal()+
  geom_col()+
  facet_wrap(~local_authority, ncol=4)


```







